<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>使用TensorRT对模型进行压缩加速 | KALUO</title>
<meta name="description" content="温故而知新">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://kaluo-zz.github.io/favicon.ico?v=1572964032355">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://kaluo-zz.github.io/styles/main.css">


<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://kaluo-zz.github.io">KALUO</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                首页
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                归档
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                标签
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                关于
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>使用TensorRT对模型进行压缩加速</h1>
            <p class="article-meta">
              2019-07-01
              
                <a href="https://kaluo-zz.github.io/tag/tMhk8q8aw" class="badge ">
                  TensorRT
                </a>
              
                <a href="https://kaluo-zz.github.io/tag/Pd55hi5zg" class="badge secondary">
                  模型压缩
                </a>
              
            </p>
            
            <div class="post-content">
              <h3 id="安装tensorrt5122">安装TensorRT5.1.2.2</h3>
<ol>
<li>
<p>到NVIDIA<a href="https://developer.nvidia.com/tensorrt">官网</a>下载对应Ubuntu系统的TensorRT5.1.2.2。</p>
</li>
<li>
<p>新建目录TensorRT，将下载的文件移动至该目录下，并解压：</p>
<pre><code class="language-bash">username@hostname:~/TensorRT$ tar xzvf TensorRT-5.1.2.2.Ubuntu-16.04.4.x86_64-gnu.cuda-9.0.cudnn7.5.tar.gz
</code></pre>
</li>
<li>
<p>添加TensorRT的绝对路径<code>LIB</code>目录到环境变量<code>LD_LIBRARY_PATH</code>:</p>
<pre><code class="language-bash">username@hostname:~/TensorRT/TensorRT-5.1.2.2$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/kaluo/TensorRT/TensorRT-5.1.2.25/lib
</code></pre>
</li>
<li>
<p>安装Python TensorRT wheel文件</p>
<pre><code class="language-bash">username@hostname:~/TensorRT/TensorRT-5.1.2.2$ cd python/
username@hostname:~/TensorRT/TensorRT-5.1.2.2/python$ ls
tensorrt-5.1.2.2-cp27-none-linux_x86_64.whl
tensorrt-5.1.2.2-cp34-none-linux_x86_64.whl
tensorrt-5.1.2.2-cp35-none-linux_x86_64.whl
tensorrt-5.1.2.2-cp36-none-linux_x86_64.whl
tensorrt-5.1.2.2-cp37-none-linux_x86_64.whl
username@hostname:~/TensorRT/TensorRT-5.1.2.2/python$ pip install tensorrt-5.1.2.2-cp27-none-linux_x86_64.whl #这里使用python2.7
Processing ./tensorrt-5.1.2.2-cp27-none-linux_x86_64.whl
Installing collected packages: tensorrt
Successfully installed tensorrt-5.1.2.2
</code></pre>
</li>
<li>
<p>如果需要将TensorRT和TensorFlow一起使用，则需要安装python UFF wheel文件。</p>
<pre><code class="language-bash">username@hostname:~/TensorRT/TensorRT-5.1.2.2$ cd uff/
username@hostname:~/TensorRT/TensorRT-5.1.2.2/uff$ ls
uff-0.6.3-py2.py3-none-any.whl
username@hostname:~/TensorRT/TensorRT-5.1.2.2/uff$ pip install uff-0.6.3-py2.py3-none-any.whl
</code></pre>
</li>
<li>
<p>安装python <code>graphsurgeon</code> wheel文件。</p>
<pre><code class="language-bash">username@hostname:~/TensorRT/TensorRT-5.1.2.2/graphsurgeon$ pip install graphsurgeon-0.4.0-py2.py3-none-any.whl
Processing ./graphsurgeon-0.4.0-py2.py3-none-any.whl
Installing collected packages: graphsurgeon
Successfully installed graphsurgeon-0.4.0
</code></pre>
</li>
</ol>
<blockquote>
<h3 id="43-tar-file-installation"><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-install-guide/index.html#installing-tar">4.3. Tar File Installation</a></h3>
<p>Note: Before issuing the following commands, you'll need to replace 5.1.x.x with your specific TensorRT version. The following commands are examples.</p>
<ol>
<li>
<p>Install the following dependencies, if not already present:</p>
<ul>
<li>Install the CUDA Toolkit 9.0, 10.0 or 10.1</li>
<li>cuDNN 7.5.0</li>
<li>Python 2 or Python 3 (Optional)</li>
</ul>
</li>
<li>
<p><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-install-guide/index.html#downloading">Download</a> the TensorRT tar file that matches the Linux distribution you are using.</p>
</li>
<li>
<p>Choose where you want to install TensorRT. This tar file will install everything into a subdirectory called TensorRT-5.1.x.x.</p>
</li>
<li>
<p>Unpack the tar file.</p>
<pre><code class="language-bash">$ tar xzvf TensorRT-5.1.x.x.Ubuntu-1x.04.x.x86_64-gnu.cuda-x.x.cudnn7.x.tar.gz
</code></pre>
<p>Where:</p>
<ul>
<li>5.1.x.x is your TensorRT version</li>
<li>Ubuntu-1x.04.x is 14.04.5, 16.04.4 or 18.04.1</li>
<li>cuda-x.x is CUDA version 9.0, 10.0, or 10.1</li>
<li>cudnn7.x is cuDNN version 7.5</li>
</ul>
<p>This directory will have sub-directories like <code>lib</code>, <code>include</code>,<code>data</code>, etc…</p>
<pre><code class="language-bash">$ ls TensorRT-5.1.x.x
bin  data  doc  graphsurgeon  include  lib  python  samples  targets  TensorRT-Release-Notes.pdf  uff
</code></pre>
</li>
<li>
<p>Add the absolute path to the TensorRT lib directory to the environment variable LD_LIBRARY_PATH:</p>
<pre><code class="language-bash">$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:&lt;eg:TensorRT-5.1.x.x/lib&gt;
</code></pre>
</li>
<li>
<p>Install the Python TensorRT wheel file.</p>
<pre><code class="language-bash">$ cd TensorRT-5.1.x.x/python
</code></pre>
<pre><code class="language-bash">$ sudo pip2 install tensorrt-5.1.x.x-cp27-none-linux_x86_64.whl
</code></pre>
<pre><code class="language-bash">$ sudo pip3 install tensorrt-5.1.x.x-cp3x-none-linux_x86_64.whl
</code></pre>
</li>
<li>
<p>Install the Python UFF wheel file. This is only required if you plan to use TensorRT with TensorFlow.</p>
<pre><code class="language-bash">$ cd TensorRT-5.1.x.x/uff
</code></pre>
<pre><code class="language-bash">$ sudo pip2 install uff-0.6.3-py2.py3-none-any.whl
</code></pre>
<pre><code class="language-bash">$ sudo pip3 install uff-0.6.3-py2.py3-none-any.whl
</code></pre>
<pre><code class="language-bash">$ which convert-to-uff
/usr/local/bin/convert-to-uff
</code></pre>
</li>
<li>
<p>Install the Python graphsurgeon wheel file.</p>
<pre><code class="language-bash">$ cd TensorRT-5.1.x.x/graphsurgeon
</code></pre>
<pre><code class="language-bash">$ sudo pip2 install graphsurgeon-0.4.0-py2.py3-none-any.whl
</code></pre>
<pre><code class="language-bash">$ sudo pip3 install graphsurgeon-0.4.0-py2.py3-none-any.whl
</code></pre>
</li>
<li>
<p>Verify the installation:</p>
<ol>
<li>Ensure that the installed files are located in the correct directories. For example, run the tree -d command to check whether all supported installed files are in place in the lib, include, data, etc… directories.</li>
<li>Build and run one of the shipped samples, for example, sampleMNIST in the installed directory. You should be able to compile and execute the sample without additional settings. For more information about sampleMNSIT, see the <a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-sample-support-guide/index.html#mnist_sample">TensorRT Sample Support Guide</a>.</li>
<li>The Python samples are in the samples/python directory.</li>
</ol>
</li>
</ol>
</blockquote>
<h1 id="pip-install-error-with-pycuda">Pip install error with PyCUDA</h1>
<h2 id="problem">Problem</h2>
<ul>
<li>
<p>I tried to install PyCUDA using <code>pip</code>:</p>
</li>
<li>
<p>The installation tries to compile a few C++ files and it failed on the very first file with this error:</p>
<pre><code class="language-bash">In file included from src/cpp/cuda.cpp:1:0:
src/cpp/cuda.hpp:14:18: fatal error: cuda.h: No such file or directory
#include &lt;cuda.h&gt;
                ^
compilation terminated.
error: command 'x86_64-linux-gnu-gcc' failed with exit status 1
</code></pre>
</li>
</ul>
<h2 id="investigation">Investigation</h2>
<p>This error was strange because I had set <code>CUDA_ROOT</code> and had added the <code>bin</code> path of CUDA installation to <code>PATH</code> environment variable. So, the installer should have found <code>cuda.h</code> which I could see was present in <code>$CUDA_ROOT/include</code></p>
<p>To see what was happening, I tried the same command with verbosity:</p>
<pre><code class="language-bash">$ sudo pip -vvv install pycuda
</code></pre>
<ul>
<li>Now I could see that it was failing to find <code>nvcc</code>.</li>
<li>On downloading the source code of PyCUDA and checking <code>setup.py</code>, I saw that the check for <code>nvcc</code> was used to figure out the <code>CUDA_ROOT</code> and <code>CUDA_INC_DIR</code>.</li>
<li>The reason <code>nvcc</code> was not visible was that <code>CUDA_ROOT</code> was set for my user, but this <code>PATH</code> is not visible when a command is run under <code>sudo</code>, as described here. The solution was to make the CUDA <code>bin</code> path visible to <code>sudo</code>.</li>
</ul>
<h2 id="solution">Solution</h2>
<p>To make the <code>$CUDA_ROOT/bin</code> available in <code>PATH</code> for <code>sudo</code>, we can follow the steps described here. For example, on my system with CUDA 7.0 I followed these steps:</p>
<ul>
<li>
<p>Created a new file <code>/etc/profile.d/cuda.sh</code> and added this line:</p>
<pre><code class="language-bash">export PATH=/usr/local/cuda-7.0/bin:$PATH
</code></pre>
</li>
<li>
<p>Opened <code>root</code> shell without resetting <code>PATH</code> and ran the pip installation:</p>
</li>
</ul>
<pre><code class="language-bash">$ sudo su -
$ pip install pycuda
</code></pre>
<p>This worked and PyCUDA was installed successfully!</p>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                下一篇
              </div>
              <a href="https://kaluo-zz.github.io/post/pytorch-huo-qu-mo-xing-xin-xi-bao-gua-flopscan-shu-liang">
                <h3 class="post-title">
                  pytorch获取模型信息（包括FLOPs、参数量）
                </h3>
              </a>
            </div>
          
        </div>
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://kaluo-zz.github.io/images/avatar.png?v=1572964032355" class="no-responsive avatar">
    <div class="text-muted">温故而知新</div>
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      最新文章
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/chong-yao-xing-cai-yang-importance-sampling">重要性采样（Importance Sampling）</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/matlab-shan-chu-jie-gou-ti-zhong-de-zi-duan">Matlab删除结构体中的字段</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/li-yong-coco-api-huo-qu-mask-bing-hui-zhi">利用coco api 获取mask并绘制</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/gpu-zhuang-tai-jian-ce">GPU状态监测</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/python-zhi-shang-san-jiao-ju-zhen">Python之上三角矩阵</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/pytorch-zhi-gather-li-jie">Pytorch之gather理解</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/linux-zhi-shell-ming-ling">Linux之shell命令</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/tikz-hui-tu">Tikz绘图</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/ubuntu-zhi-cha-kan-cpu-shi-yong-qing-kuang">Ubuntu之查看CPU使用情况</a>
            </li>
          
        
          
            <li>
              <a href="https://kaluo-zz.github.io/post/pytorch-zhi-weightdata">Pytorch之weight.data</a>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      标签列表
    </div>
    <div class="row">
      
        <a href="https://kaluo-zz.github.io/tag/6qPaooOHK" class="badge secondary">
          绘制mask
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/vA0S58AABV" class="badge secondary">
          coco
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/pSlACxuyg" class="badge secondary">
          python
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/4VtK6AiAA" class="badge ">
          gpu
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/5i-SZnsCao" class="badge success">
          gpustat
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/cjY55A-Pe" class="badge secondary">
          ubuntu
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/PgVGsZYpu" class="badge warning">
          shell
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/XpP7hQ3bK" class="badge secondary">
          linux
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/m2uV6SR6-Y" class="badge warning">
          命令
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/4K6bnBDuJ" class="badge warning">
          latex
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/vf0AuUtmM5" class="badge secondary">
          tikz
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/PzNHh70_8H" class="badge ">
          绘图
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/lFDvY_rtIK" class="badge warning">
          cpu
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/qNRCu_hfZ" class="badge secondary">
          data布局
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/_JunyD00tX" class="badge ">
          卷积核
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/rT7AxA2VY" class="badge secondary">
          pytorch
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/yvi1PqtLs" class="badge secondary">
          重定向
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/F4_bpm-PN1" class="badge warning">
          后台运行
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/eZD1Nf0zT" class="badge success">
          visdom
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/9PDDgxnN1" class="badge secondary">
          windows
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/pYPrc_nOS" class="badge success">
          jupyter notebook
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/tMhk8q8aw" class="badge secondary">
          TensorRT
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/Pd55hi5zg" class="badge success">
          模型压缩
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/WUgomcUCO" class="badge secondary">
          参数冻结
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/_n7xZJOd0" class="badge secondary">
          获取梯度
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/-AEi1Fqbq" class="badge warning">
          计算图
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/dESfnJEeE" class="badge secondary">
          Linux
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/GIxFYt7GS" class="badge secondary">
          磁盘挂载
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/jzn05sSpT" class="badge secondary">
          ssh
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/QcjFDTzeM" class="badge success">
          autossh
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/zrgqUYq1I" class="badge success">
          反向代理
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/tVPefYU-g" class="badge secondary">
          服务器
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/bAjW-e_UD" class="badge secondary">
          Deformable Convolution
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/5IwuLmF47" class="badge warning">
          叉积
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/gYv8tBs9s" class="badge ">
          多边形
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/gKuVi5cQQ" class="badge secondary">
          面积
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/1ViRR-SXR" class="badge ">
          顺时针
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/-HzodX2-Z" class="badge secondary">
          逆时针
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/Q-fXnNDSO" class="badge warning">
          matlab
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/Ib4sWZB8W" class="badge success">
          json
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/_2vcj6Je3" class="badge secondary">
          darknet
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/ZXh7J58dV" class="badge ">
          函数分析
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/5QDLVaWYn" class="badge success">
          docker
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/q7ckOahzm" class="badge success">
          ubuntu18.04
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/-EGjsU52C" class="badge secondary">
          服务器环境
        </a>
      
        <a href="https://kaluo-zz.github.io/tag/OX4bnktRr" class="badge success">
          切换gcc版本
        </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://kaluo-zz.github.io/atom.xml" target="_blank">RSS</a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>




  </body>
</html>
